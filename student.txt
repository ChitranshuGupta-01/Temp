import React from "react";
import { render, screen, fireEvent } from "@testing-library/react";
import "@testing-library/jest-dom";
import CaseDetails from "@/components/CaseDetails";

// ✅ Fixed Next.js App Router mock
const mockPush = jest.fn();
const mockBack = jest.fn();

jest.mock("next/navigation", () => ({
  useRouter: () => ({
    push: mockPush,
    back: mockBack,
    prefetch: jest.fn(),
  }),
}));

// ✅ Mock URL & file creation for "Generate Report"
global.URL.createObjectURL = jest.fn(() => "mock-url");
global.URL.revokeObjectURL = jest.fn();
global.Blob = function (content: any, options: any) {
  return { content, options };
};
document.createElement = jest.fn(() => ({
  href: "",
  download: "",
  click: jest.fn(),
}));

describe("CaseDetails Component", () => {
  const mockCaseData = {
    id: 101,
    title: "Payment Fraud Investigation",
    status: "Active",
    priority: "High",
    assignee: "John Doe",
    profile: { name: "Jane Smith", id: "P123" },
    created: "2025-10-01",
    updated: "2025-10-05",
    riskScore: 75,
    description: "A suspected payment fraud case under review.",
  };

  beforeEach(() => {
    jest.clearAllMocks();
  });

  // ✅ Render
  it("renders case details correctly", () => {
    render(<CaseDetails caseData={mockCaseData} />);

    expect(screen.getByText(/Case #101/i)).toBeInTheDocument();
    expect(screen.getByText(/Payment Fraud Investigation/i)).toBeInTheDocument();
    expect(screen.getByText(/High Priority/i)).toBeInTheDocument();
    expect(screen.getByText(/A suspected payment fraud/i)).toBeInTheDocument();
    expect(screen.getByText(/Risk Score/i)).toBeInTheDocument();
    expect(screen.getByText("75")).toBeInTheDocument();
    expect(screen.getByText(/John Doe/i)).toBeInTheDocument();
    expect(screen.getByText(/Jane Smith/i)).toBeInTheDocument();
  });

  // ✅ Navigation
  it("navigates back when Go Back button is clicked", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByTitle(/go back/i));
    expect(mockBack).toHaveBeenCalled();
  });

  // ✅ Add note flow
  it("opens note input, adds note, and displays it", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByText(/Add Note/i));

    const textarea = screen.getByPlaceholderText(/Type your note/i);
    fireEvent.change(textarea, { target: { value: "New Note" } });

    fireEvent.click(screen.getByText(/Save/i));
    expect(screen.getByText("New Note")).toBeInTheDocument();
  });

  // ✅ Edit note
  it("edits an existing note correctly", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByText(/Add Note/i));

    const textarea = screen.getByPlaceholderText(/Type your note/i);
    fireEvent.change(textarea, { target: { value: "Initial Note" } });
    fireEvent.click(screen.getByText(/Save/i));

    // Click edit
    const editButtons = screen.getAllByRole("button");
    const editButton = editButtons.find((btn) =>
      btn.querySelector("svg")?.getAttribute("class")?.includes("text-blue")
    );
    if (editButton) fireEvent.click(editButton);

    const editTextarea = screen.getByPlaceholderText(/Type your note/i);
    fireEvent.change(editTextarea, { target: { value: "Edited Note" } });
    fireEvent.click(screen.getByText(/Update/i));

    expect(screen.getByText("Edited Note")).toBeInTheDocument();
  });

  // ✅ Delete note
  it("deletes a note successfully", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByText(/Add Note/i));
    fireEvent.change(screen.getByPlaceholderText(/Type your note/i), {
      target: { value: "Note to Delete" },
    });
    fireEvent.click(screen.getByText(/Save/i));
    expect(screen.getByText("Note to Delete")).toBeInTheDocument();

    const deleteButtons = screen.getAllByRole("button");
    const deleteButton = deleteButtons.find((btn) =>
      btn.querySelector("svg")?.getAttribute("class")?.includes("text-red")
    );
    if (deleteButton) fireEvent.click(deleteButton);

    expect(screen.queryByText("Note to Delete")).not.toBeInTheDocument();
  });

  // ✅ Status update
  it("updates status using dropdown", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByText(/Update Status/i));
    fireEvent.click(screen.getByText(/Closed/i));
    expect(screen.getByText("Closed")).toBeInTheDocument();
  });

  // ✅ Generate report
  it("triggers report generation on button click", () => {
    render(<CaseDetails caseData={mockCaseData} />);
    fireEvent.click(screen.getByText(/Generate Report/i));
    expect(document.createElement).toHaveBeenCalledWith("a");
    expect(global.URL.createObjectURL).toHaveBeenCalled();
    expect(global.URL.revokeObjectURL).toHaveBeenCalled();
  });
});
